(function(T,s,a,v,l,g,f,d,w,N,h,u,y){"use strict";const $=a.stylesheet.createThemedStyleSheet({icon:{marginRight:10,tintColor:g.semanticColors.HEADER_PRIMARY}});function S(n){let{asset:t,onPress:e}=n;return a.React.createElement(a.ReactNative.TouchableOpacity,{onPress:e},a.React.createElement(a.ReactNative.Image,{style:$.icon,source:l.getAssetIDByName(t)}))}const{launchImageLibrary:k}=v.findByProps("launchImageLibrary");v.findByProps("downloadMediaAsset");const C=function(){return new Promise(function(n,t){return k({mediaType:"any",maxWidth:0,maxHeight:0,videoQuality:"high",durationLimit:0,quality:1,cameraType:"back",includeBase64:!1,includeExtra:!0,saveToPhotos:!1,selectionLimit:1},async function(e){if(e.didCancel)return t("Backup selection cancelled");if(e.errorCode)return t(`Native error: ${e.errorCode}`);const i=await fetch(e.assets[0].uri);let r;try{r=await i.json()}catch{return t("Malformed backup file")}n(r)})})},p=f.createProxy([]).proxy,A=function(n,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"info";return p.push({source:n,message:t,type:e})},B=function(n){return function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"info";return A(n,t,e)}},m=B("BackupManager"),I=function(){var n;return{settings:N.settings,...(h.identity===null||h.identity===void 0||(n=h.identity.features)===null||n===void 0?void 0:n.loaderConfig)&&{loaderConfig:h.config}}};async function x(n){const t={};for(const e of Object.values(u.plugins))e.id!==s.id&&(t[e.id]={...e,...n&&{storage:await f.createMMKVBackend(e.id).get()??{}}},m(`Added ${e.manifest.name} to backup`));return t}function O(){const n={};for(const t of Object.values(y.themes))n[t.id]=t,m(`Added ${t.data.name} to backup`);return n}async function j(n){if(Object.keys(n).length===0)throw new Error("At least one option should be selected");if(n.pluginData&&!n.plugins)throw new Error("Plugin data cannot be backed up independently of plugins");m(`Starting backup with ${Object.keys(n).join(", ")}`);const t={};return n.vendetta&&(t.vendetta=I()),n.plugins&&(t.plugins=await x(n.pluginData)),n.themes&&(t.themes=O()),t}const c=B("RestoreManager");function F(n){for(const t of Object.keys(n.settings))N.settings[t]=n.settings[t],c(`Restored settings ${t} to ${n.settings[t]}`);if(n.loaderConfig)for(let t of Object.keys(n.loaderConfig))h.config[t]=n.loaderConfig[t],c(`Restored loader config ${t} to ${n.loaderConfig[t]}`)}async function L(n,t){for(const e of Object.values(n)){if(!u.plugins[e.id])await u.fetchPlugin(e.id).catch(function(){c(`Couldn't fetch ${e.manifest.name}, falling back to local`,"warn");try{u.plugins[e.id]={id:e.id,manifest:e.manifest,enabled:e.enabled,update:e.update,js:e.js}}catch(i){const r=`Failed to restore ${e.manifest.name}`;c(`${r}
${i}`,"error"),d.showToast(r,l.getAssetIDByName("Small"))}});else try{u.stopPlugin(e.id)}catch(i){const r=`Failed to stop ${e.manifest.name}`;c(`${r}
${i}`,"error"),d.showToast(r,l.getAssetIDByName("Small"))}e.storage&&t&&await f.createMMKVBackend(e.id).set(e.storage),e.enabled&&await u.startPlugin(e.id).catch(function(i){const r=`Failed to start ${e.manifest.name}`;c(`${r}
${i}`,"error"),d.showToast(r,l.getAssetIDByName("Small"))}),c(`Restored ${e.manifest.name}`)}}async function V(n){for(const t of Object.values(n))y.themes[t.id]||await y.fetchTheme(t.id).catch(function(){try{y.themes[t.id]={id:t.id,selected:t.selected,data:t.data}}catch(e){const i=`Failed to restore ${t.data.name}`;c(`${i}
${e}`,"error"),d.showToast(i,l.getAssetIDByName("Small"))}}),t.selected&&await y.selectTheme(t.id),c(`Restored${t.selected?" and selected ":" "}${t.data.name}`)}async function _(n,t){if(Object.keys(t).length===0)throw new Error("At least one option should be selected");if(t.pluginData&&!t.plugins)throw new Error("Plugin data cannot be restored independently of plugins");c(`Starting restore with ${Object.keys(t).join(", ")}`),t.vendetta&&n.vendetta&&F(n.vendetta),t.plugins&&n.plugins&&await L(n.plugins,t.pluginData),t.themes&&n.themes&&await V(n.themes)}const{FormRow:b,FormSwitchRow:M,FormSection:W,FormDivider:H}=w.Forms,E=[{label:"Vendetta",subLabel:"Whether to include Vendetta's settings",icon:"settings",setting:"includeVendetta"},{label:"Plugins",subLabel:"Whether to include installed plugins",icon:"debug",setting:"includePlugins"},{label:"Plugin Data",subLabel:"Whether to include the data of installed plugins",icon:"ic_rulebook",setting:"includePluginData",depends:"includePlugins"},{label:"Themes",subLabel:"Whether to include installed themes",icon:"ic_theme_24px",setting:"includeThemes"}];function K(){const[,n]=a.React.useReducer(function(e){return~e},0);f.useProxy(s.storage);const t=Object.values(s.storage).every(function(e){return!e});return a.React.createElement(a.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},E.map(function(e,i){return a.React.createElement(a.React.Fragment,null,a.React.createElement(M,{label:e.label,subLabel:e.subLabel,leading:e.icon&&a.React.createElement(b.Icon,{source:l.getAssetIDByName(e.icon)}),disabled:s.storage[e.depends]===!1,value:s.storage[e.setting],onValueChange:function(r){var o;(o=e.action)===null||o===void 0||o.call(e,r),s.storage[e.setting]=r,r===!1&&(E.filter(function(R){return R.depends===e.setting}).forEach(function(R){return s.storage[R.setting]=!1}),n())}}),i!==E.length-1&&a.React.createElement(H,null))}),a.React.createElement(W,{title:"Actions"},a.React.createElement(b,{label:"Backup",leading:a.React.createElement(b.Icon,{source:l.getAssetIDByName("share")}),disabled:t,onPress:async function(){const e=await j({vendetta:s.storage.includeVendetta,plugins:s.storage.includePlugins,pluginData:s.storage.includePluginData,themes:s.storage.includeThemes}).catch(function(i){return d.showToast("Failed to create backup",l.getAssetIDByName("Small"))});a.ReactNative.Share.share({message:JSON.stringify(e),title:`vd-ms-backup-${Date.now()}`})}}),a.React.createElement(b,{label:"Restore",leading:a.React.createElement(b.Icon,{source:l.getAssetIDByName("ic_download_24px")}),disabled:t,onPress:function(){return C().then(async function(e){await _(e,{vendetta:s.storage.includeVendetta,plugins:s.storage.includePlugins,pluginData:s.storage.includePluginData,themes:s.storage.includeThemes}),d.showToast("Restored backup successfully.",l.getAssetIDByName("Check"))}).catch(function(e){return d.showToast(e,l.getAssetIDByName("Small"))})}})))}const{FormRow:D}=w.Forms;function Y(){return a.React.createElement(a.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},a.React.createElement(D,{label:"Prox-ify plugins",subLabel:"This will move any installed plugins that are on the plugin proxy to their proxied versions.",leading:a.React.createElement(D.Icon,{source:l.getAssetIDByName("ic_globe_24px")}),onPress:function(){return d.showToast("Soon\u2122")}}))}const q=a.stylesheet.createThemedStyleSheet({log:{fontSize:12,fontFamily:a.constants.Fonts.CODE_SEMIBOLD,color:g.semanticColors.TEXT_NORMAL}});function z(){const[n,t]=a.React.useState("");return f.useProxy(p),a.React.createElement(a.ReactNative.View,{style:{flex:1}},a.React.createElement(w.Search,{style:{margin:10},onChangeText:function(e){return t(e)},placeholder:"Filter"}),a.React.createElement(a.ReactNative.FlatList,{data:p.filter(function(e){return Object.values(e).some(function(i){return i.toLowerCase().includes(n)})}),renderItem:function(e){let{item:i}=e;const r=i.type==="info"?g.rawColors.BRAND_360:i.type==="warn"?g.rawColors.YELLOW_360:g.rawColors.RED_360;return a.React.createElement(a.ReactNative.Text,{style:q.log},a.React.createElement(a.ReactNative.Text,{style:{color:r}},"[",i.source,"]: "),i.message)},initialNumToRender:50}))}const{BadgableTabBar:J}=v.findByProps("BadgableTabBar"),P=[{id:"backup_restore",title:"Backup and Restore",render:K},{id:"tools",title:"Tools",render:Y}];function Q(){const n=a.NavigationNative.useNavigation(),[t,e]=a.React.useState(P[0]);return n.setOptions({headerRight:function(){return a.React.createElement(S,{asset:"debug",onPress:function(){return n.push("VendettaCustomPage",{title:"MigrationStation Logs",render:z})}})}}),a.React.createElement(a.ReactNative.View,{style:{flex:1}},a.React.createElement(a.ReactNative.View,{style:{margin:10}},a.React.createElement(J,{tabs:P,activeTab:t.id,onTabSelected:function(i){var r;const o=P.find(function(R){return R.id===i});o&&((r=o.onPress)===null||r===void 0||r.call(o,o.id),o.render&&e(o))}})),a.React.createElement(t.render,null))}return s.storage.includeVendetta??=!0,s.storage.includePlugins??=!0,s.storage.includePluginData??=!0,s.storage.includeThemes??=!0,T.settings=Q,T})({},vendetta.plugin,vendetta.metro.common,vendetta.metro,vendetta.ui.assets,vendetta.ui,vendetta.storage,vendetta.ui.toasts,vendetta.ui.components,vendetta,vendetta.loader,vendetta.plugins,vendetta.themes);
